# UI Feature Specification

Visual enhancements, modeline, tab bar, display-buffer rules, and window layout.

## Status

Documenting existing behavior.

## Files

| File                       | Purpose                                |
| :------------------------- | :------------------------------------- |
| `init/init-ui.el`          | Core UI settings and packages          |
| `init/init-modeline.el`    | doom-modeline configuration            |
| `init/init-display-buffer.el` | display-buffer-alist rules          |
| `config/mod-tabs.el`       | Tab-bar styling, alerts, transient     |
| `config/mod-pulsar.el`     | Visual feedback on eval/jump/search    |
| `config/mod-tty-frames.el` | TTY-specific display setup             |
| `config/mod-bufler.el`     | Buffer grouping with magit-section     |
| `ligatures/prog-mode.eld`  | Ligature patterns for programming      |
| `ligatures/text-mode.eld`  | Ligature patterns for text             |

## External Packages

| Package           | Purpose                                |
| :---------------- | :------------------------------------- |
| doom-modeline     | Feature-rich modeline                  |
| ligature          | Font ligature support                  |
| page-break-lines  | Display ^L as horizontal rule          |
| hide-mode-line    | Hide modeline in specific modes        |
| highlight-numbers | Number syntax highlighting             |
| hl-todo           | Highlight TODO/FIXME comments          |
| indent-bars       | Indentation guides                     |
| pulsar            | Visual pulse feedback                  |
| dimmer            | Dim inactive windows                   |
| paren-face        | Dim parentheses in lisps               |
| breadcrumb        | Show code context in header            |
| bufler            | Buffer list with magit-section         |
| anzu              | Search hit count in modeline           |
| evil-anzu         | Evil integration for anzu              |
| nerd-icons        | Icon font support                      |
| nerd-icons-corfu  | Icons in corfu completions             |

## Behaviors

### Scrolling

| Setting                  | Value         |
| :----------------------- | :------------ |
| `hscroll-margin`         | 2             |
| `hscroll-step`           | 1             |
| `scroll-conservatively`  | 10            |
| `scroll-margin`          | 0             |
| `auto-window-vscroll`    | nil           |
| `fast-but-imprecise-scrolling` | t       |

### Cursor & Selection

| Behavior                        | Value               |
| :------------------------------ | :------------------ |
| Blink cursor                    | Disabled            |
| Blink matching paren            | Disabled            |
| Stretch cursor                  | Disabled            |
| Cursor in non-selected windows  | Hidden              |
| Highlight non-selected windows  | Disabled            |

### Bidirectional Text

| Setting                       | Value          |
| :---------------------------- | :------------- |
| `bidi-display-reordering`     | left-to-right  |
| `bidi-paragraph-direction`    | left-to-right  |
| `bidi-inhibit-bpa`            | t              |

### Window Splitting

| Setting               | Value |
| :-------------------- | :---- |
| `split-width-threshold` | 160 |
| `split-height-threshold` | nil |

Prefers vertical (side-by-side) splits for wide frames.

### Keystrokes & Dialog

| Setting        | Value |
| :------------- | :---- |
| `echo-keystrokes` | 0.02 |
| `use-dialog-box` | nil  |

### Tooltips

Disabled via `(tooltip-mode -1)`.

### Tab Bar

- Enabled globally via `tab-bar-mode`
- Close button shown only on selected tab
- Add-tab button removed from format
- Current tab displayed in bold

**Keybindings:**

| Key     | Command                    |
| :------ | :------------------------- |
| `M->`   | `tab-bar-switch-to-next-tab` |
| `M-<`   | `tab-bar-switch-to-prev-tab` |
| `M-C-.` | `tab-bar-move-tab`         |
| `M-C-,` | `tab-bar-move-tab-backward` |
| `M-B`   | `+tabs-menu`               |

**Transient Menu (`+tabs-menu`):**

| Key | Navigation          | Key | Management            |
| :-- | :------------------ | :-- | :-------------------- |
| `j` | Next tab            | `c` | Create tab            |
| `k` | Previous tab        | `d` | Close tab             |
| `s` | Select by name      | `r` | Rename tab            |
|     |                     | `m` | Move tab              |
|     |                     | `u` | Undo close            |
|     |                     | `o` | Close other tabs      |

**Theme-Aware Styling:**

Tab bar faces dynamically computed based on current theme:
- Dark theme: selected tab uses mode-line background
- Light theme: selected tab uses default background
- Inactive tabs dimmed with shadow face

**Alert System:**

Tabs can have persistent or transient alerts with animated pulses:

| Function                      | Purpose                          |
| :---------------------------- | :------------------------------- |
| `+tab-bar-set-alert`          | Set persistent alert (pulses)    |
| `+tab-bar-clear-alert`        | Clear alert with fade-out        |
| `+tab-bar-set-transient-alert` | Temporary pulse animation       |

Alert clears automatically after dwelling on tab for `+tab-bar-alert-clear-delay` seconds.

**Worktree Icons:**

Tab names display icons based on `worktree-type` property:

| Type      | Icon |
| :-------- | :--- |
| `root`    |     |
| `epic`    |     |
| `task`    |     |
| `subagent`|     |
| `pullreq` |     |

### Ligatures

Enabled globally via `ligature-mode`. Patterns loaded from ELD files:
- `prog-mode`: operators, arrows, comparisons
- `text-mode`: subset without equals-based operators

Common ligatures: `=>`, `->`, `<-`, `::`, `||`, `&&`, `!=`, `==`, `<=`, `>=`

### Code Folding

`hs-minor-mode` enabled in `prog-mode`.

### Page Breaks

`page-break-lines-mode` displays `^L` as horizontal rule. Extended to:
- `rfc-mode`
- `prog-mode`
- `text-mode`

### Line Numbers

| Setting                      | Value |
| :--------------------------- | :---- |
| `display-line-numbers-width` | 3     |
| `display-line-numbers-widen` | t     |

### TODO Highlighting

`hl-todo-mode` enabled in prog/yaml/conf modes.

| Keyword    | Face                      |
| :--------- | :------------------------ |
| TODO       | warning bold              |
| FIXME      | error bold                |
| HACK       | font-lock-constant bold   |
| DEPRECATED | font-lock-doc bold        |
| NOTE       | success bold              |
| SAFETY     | success bold              |

### Indentation Guides

`indent-bars` enabled in YAML and Python modes:
- Thin bars (15% width)
- Single color (from comment face)
- No current-depth highlighting

### Pulsar (Visual Feedback)

Global mode providing visual pulse on context changes.

**Pulse Functions:**
- `forward-button`, `backward-button`, `isearch-exit`
- `evil-search-next`, `evil-search-previous`

**Removed from pulse:**
- `kill-region`, `delete-region` (interferes with puni)
- `next-error`, `previous-error` (use dedicated hook instead)
- `evil-goto-first-line` (handled via advice)

**Jump Hooks:**

| Hook                      | Actions                           |
| :------------------------ | :-------------------------------- |
| `consult-after-jump-hook` | `pulsar-recenter-top`, reveal     |
| `imenu-after-jump-hook`   | `pulsar-recenter-top`, reveal     |
| `org-agenda-after-show-hook` | `pulsar-recenter-center`, reveal |
| `org-follow-link-hook`    | `pulsar-recenter-center`, reveal  |

**Error Navigation:**

| Severity | Pulse Color |
| :------- | :---------- |
| Error    | Red         |
| Warning  | Yellow      |
| Info     | Cyan        |

**Eval Feedback:**

| Result  | Pulse Color |
| :------ | :---------- |
| Success | Green       |
| Error   | Red         |
| Buffer  | Yellow      |

**Evil Integration:**

| Action             | Pulse       |
| :----------------- | :---------- |
| `evil-yank`        | Generic     |
| `evil-jump-item`   | Line        |
| `evil-goto-line`   | Line (if count > 1) |

**Avy Integration:**

| Action              | Pulse        |
| :------------------ | :----------- |
| No matches          | Red          |
| Goto                | Line         |
| Kill/change (move)  | Magenta      |
| Kill (stay)         | Magenta      |
| Copy/lookup/ispell  | Green        |

### Dimmer

Dim inactive windows:
- Adjustment mode: `:both`
- Fraction: -0.05 (subtle)
- Colorspace: CIELAB
- Watches frame focus

Integrated with: which-key, magit, org, hydra, posframe.

### Current Line

`hl-line` with `hl-line-sticky-flag` disabled (only highlight in focused window).

### Whitespace

`whitespace-mode` with newline characters removed from display.

### Paren Matching

| Setting                           | Value    |
| :-------------------------------- | :------- |
| `show-paren-delay`                | 0.1      |
| `show-paren-when-point-inside-paren` | t     |
| `show-paren-when-point-in-periphery` | t     |
| `show-paren-context-when-offscreen` | overlay |

Context overlay formatted with `↑` prefix and full-width padding.

### Paren Face

Dims parentheses in lisp modes. Extended to:
- `elixir-ts-mode`: dims `(),&`
- `c-ts-base-mode`: dims `;,`

### Number Highlighting

`highlight-numbers` enabled in prog/conf modes with custom regexp:
```
symbol-start + digit + (? "." (* digit)) + symbol-end
```

### Hide Mode Line

Mode line hidden in:
- completion-list, Man, ielm, calendar, eshell
- compilation, help, shell-command, eat
- magit-setup-buffer, org-roam-mode

Side window integration:
- Mode line shown when side window raised
- Restored when returned to side window

### Breadcrumb

Shows code context in header. Idle time: 0.3s.

### Bufler

Buffer list using magit-section with custom grouping:

1. Auto-workspace
2. Help/Info group
3. User emacs directory
4. Org directory (with auto-indirect, auto-file)
5. Parent project (non-special)
6. /nix/store paths (grouped by package name)
7. Special buffers (Magit, Forge, Dired, grep, compilation)
8. Auto-directory fallback
9. Auto-mode fallback

### Clickable URLs

`goto-address-mode` enabled in prog/text/conf/magit-process modes.
Disabled in org-mode and org-agenda-mode (handled natively).

### Long Lines

`so-long-mode` enabled globally after elpaca init.

### Process List

`proced` with color enabled.

### Window Keybindings

| Key   | Command                       |
| :---- | :---------------------------- |
| `M-o` | `other-window`                |
| `M-_` | `window-toggle-side-windows`  |

## Display Buffer Rules

### Layout Philosophy

- Single main buffer or two side-by-side
- Side windows for transient content (docs, shell, compilation)
- Never pop open new frames

### Side Window Placement

| Side   | Window Width | Window Height | Content Types                    |
| :----- | :----------- | :------------ | :------------------------------- |
| Top    | 80           | 0.2           | Debugger, profiler, capture      |
| Left   | 80           | 0.3           | Search results, debugger record  |
| Right  | 80           | 0.3           | Help, docs, logs, org-roam       |
| Bottom | 80           | 0.3           | REPLs, shells, compilation       |

### Full-Frame Buffers

Buffers matching `^CAPTURE-` displayed full-frame.

### Top Side Buffers

- `debugger-mode`, `profiler-report-mode`
- Capture buffers (height 0.6)

### Left Side Buffers

- `grep-mode`, `occur-mode`, `embark-collect-mode`
- Embark exports, org-roam-search

### Right Side Buffers

- Shell command output, babel results, async shell
- Help modes (help, helpful, Man, woman, rfc)
- Magit log, process buffers
- org-roam, org-roam-links
- eldoc, beads-process

### Bottom Side Buffers

- `comint-mode` (REPLs)
- `eat-mode`, `eshell-mode` (shells)
- `compilation-mode`
- Org popups (calendar, agenda commands, select, note, babel error)
- ERT view, envrc

### Suppressed Buffers

- `*warnings*`
- `*async-native-compile-Log*`

### Fallback Behavior

1. Reuse same window
2. Reuse existing non-dedicated window (for dired, next-error, etc.)
3. Maybe pop up window
4. Reuse previous window
5. Use some window
6. Split sensibly

`switch-to-buffer-in-dedicated-window`: `pop`
`window-combination-resize`: `t`

## Modeline (doom-modeline)

| Setting                          | Value       |
| :------------------------------- | :---------- |
| `doom-modeline-bar-width`        | 3           |
| `doom-modeline-buffer-encoding`  | nondefault  |
| `doom-modeline-buffer-state-icon` | nil        |
| `doom-modeline-major-mode-icon`  | nil         |
| `doom-modeline-check-simple-format` | t        |
| `doom-modeline-modal`            | nil         |

Magit integration:
- `magit-status-mode`: uses magit modeline segment
- Other magit modes: mode line hidden

### Search Count (anzu)

Displays isearch result count. Evil integration via `evil-anzu`:
- Activates on `evil-ex-start-search`, `evil-ex-start-word-search`
- `global-anzu-mode` enabled after evil-anzu loads

## TTY Frames

On TTY frames:
- Vertical border uses Unicode box-drawing (`│`)
- Truncation indicator uses `…` with warning face
- Display table applied to all windows

## API

### Tab Bar Functions

| Function                       | Purpose                         |
| :----------------------------- | :------------------------------ |
| `+tabs-menu`                   | Open tab management transient   |
| `+tab-bar-set-alert`           | Set persistent alert on tab     |
| `+tab-bar-clear-alert`         | Clear alert from tab            |
| `+tab-bar-set-transient-alert` | Trigger temporary pulse         |
| `+update-tab-bar-themes`       | Refresh tab bar face colors     |
| `+tab-bar-tab-name-format`     | Format tab name with icon       |

### Tab Bar Variables

| Variable                        | Purpose                         |
| :------------------------------ | :------------------------------ |
| `+tab-bar-alert-clear-delay`    | Seconds before auto-clear (1.0) |
| `+tab-bar-alert-pulse-iterations` | Pulse animation cycles (3)   |
| `+tab-bar-alert-pulse-delay`    | Seconds between pulse steps     |

### Pulsar Macro

```elisp
(+pulsar--with-eval-pulse START END &rest BODY)
```

Pulses region green on success, red on error.

### Display Buffer Functions

| Function                              | Purpose                      |
| :------------------------------------ | :--------------------------- |
| `+display-buffer-reuse-non-dedicated-window` | Reuse for navigation |
| `+display-buffer-fallback`            | Sensible split fallback      |

### TTY Functions

| Function           | Purpose                          |
| :----------------- | :------------------------------- |
| `+tty-frame-setup` | Configure display table for TTY  |

## Testable Properties

1. Tab bar mode is active after init
2. Tab switching with `M->` and `M-<` works
3. Alert set on tab displays magenta background
4. Alert clears after dwell delay
5. Ligatures display in prog-mode buffers
6. Help buffer displays in right side window
7. Compilation buffer displays in bottom side window
8. Inactive windows are dimmed
9. TODO/FIXME highlighted in prog-mode
10. Page breaks display as horizontal rules
11. doom-modeline visible in regular buffers
12. Mode line hidden in magit non-status buffers
13. TTY frames use Unicode vertical border
