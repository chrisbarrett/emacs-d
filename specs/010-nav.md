# Navigation Feature Specification

Navigation, window management, jumping, and position history.

## Files

| File                  | Purpose                                      |
| :-------------------- | :------------------------------------------- |
| `init/init-nav.el`    | Navigation packages (windmove, avy, winner)  |
| `lisp/+window.el`     | Window splitting, dedication, side windows   |

## Dependencies

### External Packages

| Package        | Purpose                       |
| :------------- | :---------------------------- |
| `rotate`       | Window layout rotation        |
| `better-jumper`| Jump list with undo/redo      |
| `avy`          | Jump to visible text by char  |

### Built-in Packages

| Package      | Purpose                              |
| :----------- | :----------------------------------- |
| `windmove`   | Directional window navigation        |
| `winner`     | Window layout undo/redo              |
| `saveplace`  | Remember cursor position in files    |
| `frame`      | Window divider configuration         |

### Internal Dependencies

| Dependency          | Usage                                   |
| :------------------ | :-------------------------------------- |
| `mod-tty-frames`    | TTY-specific frame setup                |
| `+first-file-hook`  | Deferred loading trigger                |
| `+first-buffer-hook`| Deferred loading trigger                |

## Behavior

### Window Navigation

| Binding | Action                    | Scope     |
| :------ | :------------------------ | :-------- |
| `M-C`   | `windmove-up`             | GUI only  |
| `M-H`   | `windmove-left`           | GUI only  |
| `M-N`   | `windmove-right`          | GUI only  |
| `M-T`   | `windmove-down`           | GUI only  |

Note: Dvorak layout (C=c, H=d, N=l, T=j for up/left/right/down).

### Window Swapping

| Binding   | Action            | Side Window Behavior          |
| :-------- | :---------------- | :---------------------------- |
| `C-M-c`   | `+win-swap-up`    | Move side window to top       |
| `C-M-h`   | `+win-swap-left`  | Move side window to left      |
| `C-M-n`   | `+win-swap-right` | Move side window to right     |
| `C-M-t`   | `+win-swap-down`  | Move side window to bottom    |

For regular windows, swaps position with neighbor. For side windows, moves to that side.

### Window Focus and Side Window Management

| Binding           | Action                           |
| :---------------- | :------------------------------- |
| `M-f`             | `+toggle-window-fullframe`       |
| `M-r`             | `+toggle-side-window-raised`     |
| `M-S-<return>`    | `+toggle-window-fullframe`       |

Behaviors:
- `+toggle-window-fullframe`: Saves window config, deletes other windows; toggles back
- `+toggle-side-window-raised`: Promotes side window to main area or returns it

### Winner Mode (Layout History)

| Binding       | Action         |
| :------------ | :------------- |
| `M-<left>`    | `winner-undo`  |
| `M-<right>`   | `winner-redo`  |
| `C-.` (normal)| `winner-redo`  |

Excluded buffers: `*Completions*`, `*Compile-Log*`, `*inferior-lisp*`, `*Fuzzy Completions*`, `*Apropos*`, `*Help*`, `*cvs*`, `*Buffer List*`, `*Ibuffer*`, `*esh command on file*`

### Better Jumper (Position History)

| Binding | Action                       |
| :------ | :--------------------------- |
| `C-.`   | `better-jumper-jump-forward` |
| `C-,`   | `better-jumper-jump-backward`|

Remapped commands:
- `evil-jump-forward` → `better-jumper-jump-forward`
- `evil-jump-backward` → `better-jumper-jump-backward`
- `xref-pop-marker-stack` → `better-jumper-jump-backward`
- `xref-go-back` → `better-jumper-jump-backward`
- `pop-tag-mark` → `better-jumper-jump-backward`
- `xref-go-forward` → `better-jumper-jump-forward`

Jump points set automatically:
- Before `kill-buffer`
- Before `consult-imenu`
- Before `org-mark-ring-push`
- On `org-open-at-point-functions`

### Avy (Jump to Char)

| Binding | Action                 |
| :------ | :--------------------- |
| `M-g`   | `avy-goto-char-timer`  |

Action dispatch (type during avy selection):
| Key   | Action                    | Description                    |
| :---- | :------------------------ | :----------------------------- |
| `x`   | `avy-action-kill-stay`    | Kill, stay at current position |
| `d`   | `avy-action-kill-move`    | Kill, move to target           |
| `c`   | `+avy-action-change-move` | Kill and enter insert state    |
| `t`   | `avy-action-teleport`     | Move target to point           |
| `v`   | `avy-action-mark`         | Mark target                    |
| `y`   | `avy-action-copy`         | Copy target                    |
| `p`   | `avy-action-yank`         | Yank at point                  |
| `P`   | `avy-action-yank-line`    | Yank line at point             |
| `i`   | `avy-action-ispell`       | Spell-check target             |
| `K`   | `+avy-action-evil-lookup` | Look up definition             |
| ` `   | `avy-action-zap-to-char`  | Zap to target                  |

### Save Place

Restores cursor position when revisiting files:
- Recenters buffer after restoring position
- Uses `prin1` instead of `pp` for faster history saving

### Rotate

Available layouts: `rotate:even-horizontal`, `rotate:even-vertical`

### Frame Settings

| Setting                         | Value |
| :------------------------------ | :---- |
| `window-divider-default-places` | `t`   |
| `window-divider-default-bottom-width` | 1 |
| `window-divider-default-right-width`  | 1 |

## API

### Commands

| Command                             | Description                                   |
| :---------------------------------- | :-------------------------------------------- |
| `+toggle-window-fullframe`          | Toggle fullframe, save/restore window config  |
| `+toggle-side-window-raised`        | Toggle side window between side/main area     |
| `+toggle-window-dedication`         | Toggle window dedication to current buffer    |
| `+delete-nondedicated-windows`      | Delete all non-dedicated windows              |
| `+split-window-horizontally-dwim`   | Split horizontal, show sibling/other buffer   |
| `+split-window-vertically-dwim`     | Split vertical, show sibling/other buffer     |
| `+clone-indirect-buffer-of-region`  | Narrow clone buffer to region                 |
| `+win-swap-up`                      | Swap with window above or move side to top    |
| `+win-swap-down`                    | Swap with window below or move side to bottom |
| `+win-swap-left`                    | Swap with window left or move side to left    |
| `+win-swap-right`                   | Swap with window right or move side to right  |

### Functions

| Function                             | Signature                 | Description                          |
| :----------------------------------- | :------------------------ | :----------------------------------- |
| `+sibling-file-or-other-buffer`      | `()`                      | Get sibling file or next buffer      |
| `+side-window-p`                     | `(window)`                | Check if window is a side window     |
| `+display-buffer-alist-dimensions`   | `(buffer)`                | Get dimensions from display-buffer-alist |
| `+move-side-window-to-side`          | `(new-side)`              | Move current side window to new side |
| `+set-jump-point`                    | `()`                      | Set better-jumper jump point         |
| `+avy-action-change-move`            | `(pt)`                    | Avy action: delete and enter insert  |
| `+avy-action-evil-lookup`            | `(pt)`                    | Avy action: lookup definition        |

### Variables

| Variable                        | Default | Description                          |
| :------------------------------ | :------ | :----------------------------------- |
| `+window-original-side`         | `nil`   | Original side of raised side window  |
| `+window-return-configuration`  | `nil`   | Saved window config for fullframe    |
| `+side-window-default-width`    | `80`    | Default width for left/right sides   |
| `+side-window-default-height`   | `0.3`   | Default height for top/bottom sides  |

### Hooks

| Hook                        | Description                           |
| :-------------------------- | :------------------------------------ |
| `+side-window-raised-hook`  | Run when side window is raised        |
| `+side-window-returned-hook`| Run when side window is returned      |

## Design Decisions

1. **Dvorak-oriented bindings**: M-C/H/N/T match Dvorak's up/left/right/down positions
2. **GUI-only modifiers**: M-S and C-M bindings don't work in terminals (uses Zellij instead)
3. **Side window awareness**: Swap commands intelligently handle side windows vs regular windows
4. **DWIM splits**: Splits show sibling file (via `find-sibling-file`) or another unvisible buffer
5. **Unified jump list**: better-jumper replaces multiple jump commands (evil, xref) for consistency
6. **Vim-flavored avy**: Custom dispatch actions (`c` for change, `K` for lookup)

## Testable Properties

1. `windmove-up/down/left/right` bound to `M-C/T/H/N`
2. `winner-mode` enabled after first file/buffer
3. `better-jumper-mode` enabled after first file/buffer
4. `C-,` and `C-.` jump backward/forward in normal state
5. `save-place-mode` enabled
6. `window-divider-mode` enabled
7. `+toggle-window-fullframe` saves and restores window configuration
8. `+win-swap-*` moves side windows to corresponding side
9. `avy-dispatch-alist` includes custom `c` and `K` actions
