# VCS Feature Spec

Git porcelain, worktree management, and forge integration.

## Files

| File                       | Purpose                                          |
| :------------------------- | :----------------------------------------------- |
| `init/init-vcs.el`         | Magit, transient, git-timemachine, forge, beads  |
| `config/mod-magit.el`      | Display buffer, emoji, diff visit, worktree prune |
| `config/mod-worktrees.el`  | Tab-per-worktree workflow, claude-code integration |
| `config/mod-browse-at-remote.el` | Emacs 31 compat, git-timemachine integration |
| `lisp/+git.el`             | Repository display name utilities                |

## External Packages

| Package             | Purpose                                      |
| :------------------ | :------------------------------------------- |
| `transient`         | Pop-up command menus with switches           |
| `magit`             | Git porcelain                                |
| `beads`             | Issue tracker integration (emacs-beads)      |
| `git-timemachine`   | Browse file history interactively            |
| `browse-at-remote`  | Open file/region in GitHub/GitLab/etc.       |
| `forge`             | GitHub/GitLab PR and issue integration       |
| `git-auto-commit-mode` | Auto-commit files on save (for org files) |

## Behaviors

### Transient

| Setting            | Value                              |
| :----------------- | :--------------------------------- |
| Escape binding     | `transient-quit-one` on `[escape]` |

### Magit

| Setting                              | Value                                  |
| :----------------------------------- | :------------------------------------- |
| `magit-display-buffer-function`      | `+magit-display-buffer-same-frame`     |
| `magit-bury-buffer-function`         | `magit-restore-window-configuration`   |
| `magit-diff-visit-prefer-worktree`   | `t`                                    |
| `magit-diff-refine-hunk`             | `t` (word-level diff)                  |
| `magit-save-repository-buffers`      | `dontask`                              |
| `magit-revision-insert-related-refs` | `nil`                                  |
| `magit-format-file-function`         | `magit-format-file-nerd-icons`         |

#### Display Buffer

`+magit-display-buffer-same-frame` displays magit buffers:
- Diff buffers: in another window in the same frame (below selected)
- Other magit buffers: in same window

Constrains to current frame when using per-project frames.

#### Diff Visit

| Binding       | Command                               | Description                    |
| :------------ | :------------------------------------ | :----------------------------- |
| `S-<return>`  | `+magit-diff-visit-file-unselected`   | Visit file, keep magit focused |

#### Emoji Display

`:emoji:` shortcodes rendered as Unicode in:
- `git-commit-mode` buffers
- `magit-revision-mode` buffers

Data sourced from GitHub's gemoji project, cached locally.

#### Worktree Prune

Added to `magit-worktree` transient:
| Key | Command                | Description                   |
| :-- | :--------------------- | :---------------------------- |
| `p` | `+magit-worktree-prune` | Prune stale worktree info    |

#### Insert State on Empty Commit

When entering `git-commit-mode` with empty message, automatically enter evil insert state.

### Beads Integration

| Setting                        | Value                              |
| :----------------------------- | :--------------------------------- |
| `beads-worktree-root-function` | `+worktrees-path-for-selected-tab` |

### Git Timemachine

| Setting                               | Value                                 |
| :------------------------------------ | :------------------------------------ |
| `git-timemachine-show-minibuffer-details` | `t`                               |
| Revision display                      | Header line (via advice)              |

| Binding | Command                                   |
| :------ | :---------------------------------------- |
| `C-p`   | `git-timemachine-show-previous-revision`  |
| `C-n`   | `git-timemachine-show-next-revision`      |
| `gb`    | `git-timemachine-blame`                   |
| `gtc`   | `git-timemachine-show-commit`             |

Font-lock and evil keymaps enabled in `git-timemachine-mode`.

### Browse at Remote

| Setting                                          | Value   |
| :----------------------------------------------- | :------ |
| `browse-at-remote-add-line-number-if-no-region-selected` | `nil` |

#### Emacs 31 Compatibility

Overrides for changed `vc-git--call` signature:
- `browse-at-remote--get-local-branch`
- `browse-at-remote--get-remote-url`
- `browse-at-remote--get-remotes`
- `browse-at-remote--get-from-config`

#### Git Timemachine Integration

`browse-at-remote-get-url` advised to use revision from active git-timemachine session.

### Forge

| Binding (magit-mode-map)           | Command               |
| :--------------------------------- | :-------------------- |
| `magit-browse-thing` (remapped)    | `forge-browse`        |
| Remote section browse              | `forge-browse-remote` |
| Branch section browse              | `forge-browse-branch` |
| `q` in topic list                  | `kill-current-buffer` |

Loads lazily via `:after-call magit-status`.

### VC Settings

| Setting                  | Value          |
| :----------------------- | :------------- |
| `vc-follow-symlinks`     | `t`            |
| `vc-handled-backends`    | `'(Git)`       |
| `vc-directory-exclusion-list` | + node_modules, cdk.out, target, .direnv |

### Git Auto-Commit Mode

| Setting                | Value |
| :--------------------- | :---- |
| `gac-silent-message-p` | `t`   |

Safe local variables:
- `gac-debounce-interval` (integerp)
- `gac-automatically-add-new-files-p` (booleanp)

### Worktrees Workflow

Tab-per-worktree workflow inspired by zellij. Each tab represents a git worktree.

#### Global Bindings

| Binding | Command                   |
| :------ | :------------------------ |
| `M-G`   | `+worktrees-menu`         |
| `M-O`   | `+worktrees-create-switch` |

#### Transient Menu (`+worktrees-menu`)

| Section  | Key | Command                           | Condition                    |
| :------- | :-- | :-------------------------------- | :--------------------------- |
| Change   | `r` | `+worktrees-work-on-issue`        | In repo                      |
| Change   | `o` | `+worktrees-create-switch`        | In repo                      |
| Update   | `u` | `+worktrees-rebase-on-local-main` | Child worktree               |
| Update   | `U` | `+worktrees-rebase-on-origin-main`| Child worktree               |
| Complete | `m` | `+worktrees-absorb-into-main`     | Child worktree               |
| Complete | `x` | `+worktrees-destroy-current`      | Child worktree               |
| Beads    | `n` | `beads-issue-create`              | In repo                      |
| Beads    | `` ` `` | `beads-process-show-log`      | In repo                      |
| Show     | `g` | `+worktrees-magit-status`         | In repo                      |
| Show     | `c` | `+worktrees-claude-code`          | In repo                      |

#### Worktree Path

New worktrees created under `.worktrees/` inside repository root.

#### Tab Properties

Tabs store:
- `worktree-path`: Path to the worktree
- `worktree-type`: Symbol (`root`, `branch`, `pullreq`)

#### Tab Alerts

| Function                        | Description                          |
| :------------------------------ | :----------------------------------- |
| `+worktrees-set-alert`          | Persistent alert until user dwells   |
| `+worktrees-set-transient-alert`| Pulse animation, auto-clears         |
| `+worktrees-clear-alert`        | Clear persistent alert               |

#### Claude Code Integration

`+worktrees-claude-code` runs claude-code-ide scoped to worktree.

Files opened via claude-code-ide or emacsclient route to correct frame/tab via:
- `find-file` advice
- `server-visit-files` advice

#### Forge Checkout Integration

`forge-checkout-worktree` advised to:
- Create worktree in `.worktrees/{number}-{head-ref}`
- Open tab for the worktree

#### Tab Cleanup

On tab close:
- Stop claude-code-ide if running
- Kill buffers associated with worktree

## API

### Commands

| Command                           | Description                                      |
| :-------------------------------- | :----------------------------------------------- |
| `+worktrees-menu`                 | Open worktree transient menu                     |
| `+worktrees-create-switch`        | Create or switch to worktree                     |
| `+worktrees-work-on-issue`        | Create worktree from beads issue                 |
| `+worktrees-magit-status`         | Magit status for current worktree                |
| `+worktrees-claude-code`          | Run claude-code for worktree                     |
| `+worktrees-destroy-current`      | Delete worktree, branch, and tab                 |
| `+worktrees-absorb-into-main`     | Merge branch to main, delete worktree            |
| `+worktrees-rebase-on-local-main` | Rebase on local main branch                      |
| `+worktrees-rebase-on-origin-main`| Fetch and rebase on origin/main                  |
| `+worktrees-open-tab`             | Open or switch to tab for worktree               |
| `+worktrees-adopt-initial-tab`    | Set up initial tab as repo root                  |
| `+magit-worktree-prune`           | Prune stale worktree information                 |
| `+magit-diff-visit-file-unselected` | Visit file keeping magit focused               |
| `+git-commit-emoji-download-data` | Download GitHub emoji data                       |

### Functions

| Function                          | Description                                      |
| :-------------------------------- | :----------------------------------------------- |
| `+worktrees-path-for-selected-tab`| Get worktree path for current tab                |
| `+worktrees-tab-dedicated-to-child-p` | True if tab is for child worktree           |
| `+worktrees-set-alert`            | Set persistent tab alert                         |
| `+worktrees-set-transient-alert`  | Set pulsing tab alert                            |
| `+worktrees-clear-alert`          | Clear tab alert                                  |
| `+worktrees-refresh-magit`        | Refresh magit buffers for worktree               |
| `+worktrees-close-tabs`           | Close tabs for worktree path                     |
| `+git-repo-display-name`          | Get owner/repo format for GitHub repos           |

### Variables

| Variable                          | Description                                      |
| :-------------------------------- | :----------------------------------------------- |
| `+worktrees-worktree-base-dir`    | Base directory for worktrees (`.worktrees`)      |
| `+git-commit-emoji-data-url`      | URL to GitHub gemoji data                        |
| `+git-commit-emoji-cache-file`    | Path to cached emoji JSON                        |
| `+git-commit-emoji-table`         | Hash table of emoji shortcodes                   |

## Testable Properties

1. `transient-quit-one` bound to escape in transient-map
2. Magit diff buffers display in separate window in same frame
3. `:emoji:` shortcodes render as Unicode in git-commit-mode
4. `git-timemachine-mode` shows revision in header-line
5. `browse-at-remote-get-url` returns correct URL in git-timemachine session
6. Forge browse commands remap correctly in magit-mode-map
7. `+worktrees-create-switch` creates worktree under `.worktrees/`
8. Tab close kills worktree buffers and stops claude-code-ide
9. `+git-repo-display-name` returns owner/repo for GitHub URLs
